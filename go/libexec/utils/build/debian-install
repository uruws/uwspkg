#!/bin/sh
set -eu

builddir=${1:?'build dir?'}
variant=${2:?'variant?'}
repo=${3:?'repo?'}
secrepo=${4:?'secrepo?'}
distro=${5:?'distro?'}

export PATH=/usr/sbin:/usr/bin:/sbin:/bin

debinst="/usr/sbin/debootstrap --force-check-gpg --variant=${variant}"
debinst="${debinst} --cache-dir=${builddir}/cache/debootstrap"

mkdir -vp ${builddir}/chroot/debian
baseroot=${builddir}/chroot/debian/${distro}
schroot_source="schroot -c source:uwspkg-debian-${distro} -d /root"

if ! test -d ${baseroot}; then
	${debinst} ${distro} ${baseroot} ${repo}
	oldwd=${PWD}
	cd ${baseroot}
	printf 'deb %s/ %s main\n' ${repo} ${distro} >./etc/apt/sources.list
	printf 'deb %s/ %s-updates main\n' ${repo} ${distro} >>./etc/apt/sources.list
	printf 'deb %s %s/updates main\n' ${secrepo} ${distro}>>./etc/apt/sources.list
	${schroot_source} -- apt-get update -yy
	${schroot_source} -- apt-get install -yy --no-install-recommends --purge apt bash
	${schroot_source} -- apt-get clean -yy
	rm -rf ./var/lib/apt/lists/* ./var/cache/apt/archives/*.deb \
		./var/cache/apt/*cache.bin
	cd ${oldwd}
fi

exit 0
