#!/bin/sh
set -eu

builddir=${1:?'build dir?'}
cfgdir=${2:?'config dir?'}
dstdir=${3:?'config dest dir?'}
pkgdir=${4:?'packages dir?'}

shift 4
debpkgs="$@"

for pkg in ${debpkgs}; do
	dpkg -s ${pkg} >/dev/null 2>/dev/null || {
		apt-get install -yy --no-install-recommends ${pkg}
	}
done

schroot_conf=${cfgdir}/chroot.d/uwspkg.conf

install -v -d -m 0755 ${builddir}/build
install -v -d -m 0755 ${builddir}/cache/debootstrap
install -v -d -m 0755 ${builddir}/union/overlay ${builddir}/union/underlay

install -v -d -m 0755 ${dstdir}/chroot.d

if ! test -s ${schroot_conf}; then
	echo "${schroot_conf}: file not found" >&2
	exit 1
fi

cfgtmp=$(mktemp /tmp/uwspkg-build-setup.XXXXXXXX)
cat ${schroot_conf} |
	sed "s#@BUILDDIR@#${builddir}#g" >${cfgtmp}

install -v -C -m 0644 ${cfgtmp} ${dstdir}/chroot.d/uwspkg.conf
rm -f ${cfgtmp}

intprof_src=${cfgdir}/internal-uwspkg
intprof_dst=${dstdir}/internal-uwspkg

rm -rf ${intprof_dst}
install -d -m 0755 ${intprof_dst}
install -m 0644 ${intprof_src}/* ${intprof_dst}/

intfstab=${intprof_dst}/fstab
libexec_dir=`realpath -e $(dirname $0)/../`

echo "" >>${intfstab}
echo "# internal setup" >>${intfstab}
echo "${pkgdir} /uwspkg/src none ro,bind 0 0" >>${intfstab}
echo "${libexec_dir}/internal /uwspkg/libexec/internal none ro,bind 0 0" >>${intfstab}
echo "${dstdir} /etc/schroot none rw,bind 0 0" >>${intfstab}
echo "${builddir}/build /build none rw,bind 0 0" >>${intfstab}

exit 0
