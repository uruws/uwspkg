#!/bin/sh
set -eu

builddir=${1:?'build dir?'}
cfgdir=${2:?'config dir?'}
prof=${3:?'profile?'}

if test 'Xdefault' = "X${prof}"; then
	exit 0
fi

profdir=${cfgdir}/uwspkg-${prof}
distro=$(cat ${profdir}/debian.distro)

baseroot=${builddir}/chroot/debian/${distro}
dstroot=${builddir}/chroot/${prof}

if test -d ${dstroot}; then
	exit 0
fi

rsync -ax --delete-before ${baseroot}/ ${dstroot}/
echo "uwspkg-${prof}" | tee ${dstroot}/etc/debian_chroot

debpkg=${profdir}/debian.install
schroot_source="schroot -c source:uwspkg-${prof} -d /root"

if test -s ${debpkg}; then
	cat ${debpkg} | xargs ${schroot_source} -- \
		apt-get install --no-install-recommends -yy --purge
	${schroot_source} -- apt-get autoremove --purge -yy
	${schroot_source} -- apt-get clean -yy
	oldwd=${PWD}
	cd ${dstroot}
	rm -rf ./var/lib/apt/lists/* ./var/cache/apt/archives/*.deb \
		./var/cache/apt/*cache.bin
	cd ${oldwd}
fi

exit 0
